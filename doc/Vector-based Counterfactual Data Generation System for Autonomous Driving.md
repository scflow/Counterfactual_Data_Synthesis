# 方案名称：基于纯向量仿真的反事实自动驾驶数据生成系统

**(Vector-based Counterfactual Data Generation System for Autonomous Driving)**

## 1. 项目背景与核心目标

### 1.1 背景

当前自动驾驶模型训练面临严重的**长尾数据匮乏**问题。真实路测数据中，99% 都是枯燥的正常驾驶，极度缺乏“危险边缘”或“错误修正”的高价值样本。依靠真实碰撞采集数据不仅成本高昂，而且由于伦理限制不可行。

### 1.2 目标

构建一套**轻量级、高并发**的数据工厂，利用真实路采数据（Log Data），通过数学仿真手段生成海量**“反事实（Counterfactual）”**轨迹数据。这些数据描述了“如果在某时刻车辆发生了误操作（如误踩油门、偏离车道），专家系统是如何将其安全救回的”。

### 1.3 核心指标

* **仿真类型**：纯向量/状态仿真（无图像渲染），速度需达到实时流的 1000 倍以上。
* **可复现性**：通过种子机制（Seed Mechanism）实现 100% 的场景确定性复现。
* **物理真实性**：基于运动学自行车模型，确保轨迹符合车辆物理限制。

---

## 2. 系统架构设计

系统整体分为四层架构：**数据接入层**、**核心仿真层**、**策略干扰层**、**数据输出层**。

### 2.1 数据接入层 (Data Ingestion Layer)

负责解析原始路测数据和高精地图。

* **轨迹提取器**：从 nuScenes/Waymo 数据集中提取自车（Ego）及周围障碍物（Agents）的历史轨迹 。
* **地图解析器**：将复杂的几何地图转换为算法可用的**离散车道中心线点集 (Waypoints)**。这是专家系统判断“路在哪”的唯一依据。

### 2.2 策略干扰层 (The Perturber)

系统的“捣乱者”，负责制造反事实分歧点。

* **种子管理器**：将场景 ID (Token) 转化为唯一的随机种子，确保每个场景的扰动是固定的。
* **扰动动作库**：预定义的错误动作集合（如急刹、猛打方向、漂移等）。

### 2.3 核心仿真层 (Simulation Core)

系统的“世界模型”，负责推演物理结果。

* **运动学引擎**：基于自行车模型（Bicycle Model）计算车辆下一帧状态。
* **伪专家系统 (Pseudo-Expert)**：基于规则（PID + IDM）的控制器，负责在车辆被干扰后接管控制，尝试修正错误。

### 2.4 数据输出层 (Data Sink)

* **质量过滤器**：剔除物理违规或无意义的数据。
* **格式化存储**：将生成的轨迹、标签、场景元数据打包存储。

---

## 3. 详细模块功能设计

### 3.1 扰动工厂设计 (Perturbation Factory)

这是生成“反事实”的核心。我们需要设计多维度的扰动策略：

1. **脉冲式扰动 (Impulse)**：在  时刻施加单次强干扰，随后立即撤销。
* *典型动作*：误踩油门（Kick-down）、误踩刹车（Panic Brake）、方向盘手滑（Jerk）。


2. **持续性扰动 (Continuous)**：在  时间段内叠加噪声。
* *典型动作*：长时漂移（Drift，模拟四轮定位偏差）、方向盘卡死（Frozen Steering）。


3. **语义级扰动 (Semantic)**：改变驾驶意图。
* *典型动作*：虚假变道（Fake Lane Change，车头探出又缩回）、强行切入（Aggressive Cut-in）。



### 3.2 伪专家设计 (The Pseudo-Expert)

专家系统的任务是充当“守护天使”，其核心逻辑必须简单、鲁棒、可解释。不建议使用神经网络，建议使用经典控制理论。

1. **横向控制 (PID)**：
* 输入：车辆当前位姿、最近车道中心线。
* 计算：横向误差 (CTE) 和航向误差 (Heading Error)。
* 输出：方向盘转角。确保车辆能平滑地画出 S 型曲线回到车道。


2. **纵向控制 (IDM)**：
* 输入：与前车的距离、相对速度。
* 输出：加速度/减速度。确保不发生追尾。



### 3.3 物理约束系统 (Physics Clamping)

为了防止生成“科幻片”数据，必须对所有输出施加硬约束：

* **转角限制**：前轮转角不得超过机械极限（如 ）。
* **加速度限制**：加减速不得超过轮胎摩擦圆极限（如 ）。
* **非完整约束**：车辆不能横向平移，只能沿车头方向移动。

---

## 4. 业务流程逻辑 (Pipeline Workflow)

以下是单条数据生成的标准生命周期：

1. **初始化 (Init)**：
* 加载场景 ，获取对应的地图  和初始状态 。
* 利用  生成唯一随机种子 。


2. **扰动注入 (Injection)**：
* 根据  从扰动库中随机抽取一个策略（例如：向左猛打方向 ）。
* 在  时刻，强制覆盖原有动作，执行扰动动作。


3. **仿真闭环 (Loop)**：
* **感知**：专家系统读取当前状态，计算与车道线的偏差。
* **决策**：专家系统计算修正动作（例如：向右回正方向）。
* **执行**：运动学引擎根据修正动作更新车辆位置到 。
* **记录**：保存当前帧的状态数据。


4. **验证与过滤 (Validation)**：
* 检查生成的轨迹是否发生碰撞？
* 检查车辆是否驶出地图边界（Off-road）？
* 如果发生碰撞，标记为“事故负样本”。
* 如果没有碰撞且成功回正，标记为“高价值安全样本”。



---

## 5. 数据应用与交付物

### 5.1 交付数据格式

生成的每一条数据应包含以下字段：

* `Scene_Token`: 原始场景 ID。
* `Perturbation_Type`: 施加的扰动类型（如 "Sudden_Left_Turn"）。
* `Trajectory`: 生成的  时间序列。
* `Is_Recovered`: 是否成功救车（Boolean）。
* `Min_TTC`: 最小碰撞时间（用于衡量危险程度）。

### 5.2 数据用途

1. **行为预测训练 (Prediction)**：让模型学习在车辆偏离时，未来可能的轨迹是什么。
2. **规划控制训练 (Planning)**：作为强化学习（RL）或模仿学习（IL）的初始分布，让模型学习如何从错误状态恢复（Recovery Policy）。
3. **评测基准 (Benchmark)**：构建一套“高危场景库”，用于测试新的自动驾驶算法是否安全。

---

## 6. 总结与优势

这套方案的最大优势在于**“低成本、高产出”**：

1. **极速生成**：相比 CARLA 等渲染仿真，本方案只需计算矩阵，单机单核每秒可生成数百条轨迹。
2. **无限拓展**：只需增加扰动库的动作类型，就能无限扩充数据的丰富度。
3. **完全可控**：通过随机种子机制，任何一条异常数据都可以被精确定位和复现，便于算法调试。

这是一个非常适合快速落地、验证算法鲁棒性的数据闭环方案。